<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <script src="https://cdn.bootcss.com/d3/3.5.14/d3.js"></script>
    <link rel="stylesheet" href="../../static/css/index.css">
    <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
    <script th:src="@{/static/js/jquery.min.js}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/4.1.0/echarts-en.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=COCfvS8ZjqUa3ZoaN7CIX4rzrP0Z1Oid"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/Heatmap/2.0/src/Heatmap_min.js"></script>
    <script th:src="@{/static/js/MarkerClusterer_min.js}"></script>
    <script th:src="@{/static/js/TextIconOverlay_min.js}"></script>
    <script th:src="@{/static/js/GeoUtils.js}"></script>

    <script th:src="@{/static/js/d3.v3.js}"></script>
    <script th:src="@{/static/js/d3tip.js}"></script>
    <title>个人中心</title>
    <link rel="shortcut icon" href="../../static/img/favicon.icon" type="image/x-icon">
</head>
<body>
    <div id="allmap" style="position:absolute;left: 14%;height: 100%;;width: 45%">

    </div>
    <div id="div1">
        <img style="width: 70px;height: 70px;border-radius: 50%;position: absolute;top: 8%;left: 50%;transform: translate(-50%, -8%)" src="../../static/img/seven.jpg" />
        <label id="username" th:text="${user.username}"></label>
        <label id="personInfo">个人信息</label>
        <hr size="7 px" style="position:relative;top:220px;background-color: floralwhite;border: none">
        <label>年龄：<input id="age" th:value="${user.age}" disabled="disabled" maxlength="3" autocomplete="off"
                         oninput="value=value.replace(/^(0+)|[^\d]+/g,'')" placeholder="请输入年龄"
                         style="font-weight: 500;border: none;background-color: #F8F5F1;width: 160px;height: 26px;font-size: 14px"><br></label><br>

        <label>性别：<select id="sex" th:value="${user.sex}" disabled="disabled" required="required"
                          style="width: 160px;height: 24px;text-align: center;text-align-last: center;background-color: #F8F5F1;font-weight: 500;border: none;height: 26px;font-size: 14px" >
            <option value="男" th:selected="${user.sex=='男'}">&nbsp&nbsp&nbsp&nbsp男</option>
            <option value="女" th:selected="${user.sex=='女'}">&nbsp&nbsp&nbsp&nbsp女</option>
        </select></label><br><br>

        <label>电话：<input id="phone" th:value="${user.phone}" disabled="disabled" maxlength="11" autocomplete="off"
                         oninput="value=value.replace(/[^\d]/g,'')" placeholder="请输入电话"
                         style="font-weight: 500;border: none;background-color: #F8F5F1;width: 160px;height: 26px;font-size: 14px"><br></label><br>

        <label>邮箱：<input id="email" th:value="${user.email}" disabled="disabled" maxlength="16" autocomplete="off" placeholder="请输入邮箱"
                         style="font-weight: 500;border: none;background-color: #F8F5F1;width: 160px;height: 26px;font-size: 14px"><br></label><br>

        <label>密码：<input id="password" type="password" th:value="${user.password}" disabled="disabled" maxlength="16" autocomplete="off" placeholder="请输入密码"
                         style="font-weight: 500;border: none;background-color: #F8F5F1;width: 160px;height: 26px;font-size: 14px"></label>

        <button id="edit">编辑</button> <button id="submit" onclick="update()">提交</button>
        <button id="back" onclick="back()">返回</button>
        <input type="hidden" th:value="${StoreList}" id="StoreInfo">
    </div>
</body>
<script>
    $("#edit").click(function(){
        $("#submit").slideToggle();
        $("#back").slideToggle();
        $(this).hide();
        $("input").removeAttr("disabled");
        $("input").css("background-color","white");
        $("#sex").removeAttr("disabled");
        $("#sex").css("background-color","white");

        /*一定放在此编辑事件内部，获取的应该是每次点击编辑后，但还未进行更改时的数据。
        放在外面，会导致更改信息保存后，再来编辑时，点击返回，会显示更改前的信息*/
        $("input").attr('InitValue',function () {       /*获取除了sex以外对初始值*/
            return this.value;
        })
        $("#sex").attr('InitSex',function () {          /*获取sex初始值*/
            return this.value;
        })
    });

    function back() {                               /*还原初始值*/
        $("input").val(function () {
            return this.getAttribute('InitValue');
        });

        $("#sex").val(function () {
            return this.getAttribute('InitSex')
        });

        $("#back").hide();
        $("#submit").hide();
        $("#edit").slideToggle();
        $("input").attr("disabled",true);
        $("input").css("background-color", "#F8F5F1");
        $("#sex").attr("disabled",true);
        $("#sex").css("background-color","#F8F5F1");
    }

    function update() {
        var username = $("#username").html();
        var age = $("#age").val();
        var sex = $("#sex").val();
        var phone = $("#phone").val();
        var email = $("#email").val();
        var password = $("#password").val();
        var data = {username:username,age:age,sex:sex,phone:phone,email:email,password:password};
        if(age == ""){
            $("#age").attr("class","input change");
        }
        else if(phone == ""){
            $("#phone").attr("class","input change");
        }
        else if(email == ""){
            $("#email").attr("class","input change");
        }
        else if(password == ""){
            $("#password").attr("class","input change");
        }
        else {
            $.ajax({
                url: '/update',
                type: 'post',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify(data),
                success: function (res) {
                    if (res.code == 200) {
                        alert(res.desc);
                        if(res.change) {
                            window.location.href = "/page/jump?page=login.html";
                        }
                        $("#back").hide();
                        $("#submit").hide();
                        $("#edit").slideToggle();
                        $("input").attr("disabled",true);
                        $("input").css("background-color", "#F8F5F1");
                        $("#sex").attr("disabled",true);
                        $("#sex").css("background-color","#F8F5F1");
                    }else{
                        alert(res.desc);
                    }
                }
            })
        }
    }


    function initMap(){
        getdistrict();
        createStore();

    }

    //地图绘制
    var map = new BMap.Map("allmap", {
        minZoom:4,maxZoom:25,//缩放设置
        enableMapClick: false //关闭自带标签
    }); // 创建Map实例
    map.centerAndZoom("成都", 7); // 初始化地图,设置中心点坐标和地图级别
    //添加地图类型控件
    map.addControl(new BMap.MapTypeControl({
        mapTypes: [
            BMAP_NORMAL_MAP,
            BMAP_HYBRID_MAP
        ]
    }));
    map.setCurrentCity("成都"); // 设置地图显示的城市 此项是必须设置的
    map.enableScrollWheelZoom(true);
    var mapstyle={style:"googlelite"};
    map.setMapStyle(mapstyle);

    //地区边界
    function getdistrict() {
        getBoundary("四川省");
        getBoundary("辽宁");
        getBoundary("北京");
        getBoundary("甘肃");
    }
    function getBoundary(districtname) {
        var plys = [];
        var bdary = new BMap.Boundary();
        var line = bdary.get(districtname, function(rs) {
            var district = new Object();
            var count = rs.boundaries.length;
            //建立多边形覆盖物
            for(var i = 0; i < count; i++) {
                district.ply = new BMap.Polygon(rs.boundaries[i], {
                    strokeWeight: 2,
                    strokeOpacity: 0.8,
                    StrokeStyle: "solid",
                    strokeColor: "#1abc9c",
                    fillColor: "#ffffff",
                    fillOpacity: 0.2
                });
                plys.push(district.ply);
                map.addOverlay(district.ply); //添加覆盖物
            }
            district.ply.disableMassClear(); //添加不可去除标签
            return district;
        });
    }
    setTimeout(function() {
        getdistrict();
    }, 100);

    //绘制电商
    var makers = [];
    var markerClusterer = new BMapLib.MarkerClusterer(map,{makers:makers,
        styles : [{
            url:'../../static/img/StoreList.png',
            size: new BMap.Size(48,48),
            backgroundColor : '#4783E7'
        }],
    });
    var myIcon = new BMap.Icon("../../static/img/store.png", new BMap.Size(16,16));
    function createStore() {
        var store = $("#StoreInfo").val();
        store=eval(store);
        console.log(store.length);
        map.clearOverlays();
        markerClusterer.clearMarkers();
        var makers = [];
        var pt = null;
        for(var i=0;i<store.length;i++){
            var lat = store[i].lat;
            var lng = store[i].lon;
            console.log(lat);
            console.log(lng);
            var name = store[i].store_name;
            var point = new BMap.Marker(pt,{icon:myIcon});
            var infoWindow = new BMap.InfoWindow(name);
            point.infoWindow = infoWindow;
            pt = new BMap.Point(lng,lat);
            point.addEventListener("click",function (e) {
                this.openInfoWindow(e.target.infoWindow);
            });
            makers.push(point);
            if (i==0){
                var lat = store[i].lat;
                var lng = store[i].lon;
                var name = store[i].store_name;
                var point = new BMap.Marker(pt,{icon:myIcon});
                var infoWindow = new BMap.InfoWindow(name);
                point.infoWindow = infoWindow;
                pt = new BMap.Point(lng,lat);
                point.addEventListener("click",function (e) {
                    this.openInfoWindow(e.target.infoWindow);
                });
                makers.push(point);
            }
        }
        markerClusterer.addMarkers(makers);
    }
    initMap();


</script>
</html>